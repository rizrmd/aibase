# AiBase Chat Architecture - Complete Guide

This directory contains comprehensive documentation about the chat and conversation architecture.

## Documentation Files

### 1. **CHAT_ARCHITECTURE.md** (Main Reference)
   - Complete architectural overview
   - Storage mechanisms (frontend + backend)
   - Message types and interfaces
   - Data storage organization
   - Project IDs and Conversation ID management
   - Message flow and persistence
   - Key components and responsibilities
   - Current limitations

### 2. **QUICK_REFERENCE.md** (Fast Lookup)
   - Quick paths to key files
   - Common questions and answers
   - Important concepts explained
   - Common tasks and how to do them
   - Debug tips
   - File organization guide
   - Current status

### 3. **DATA_FLOW.md** (Visual Flows)
   - User message to LLM response flow
   - Client connection and history load flow
   - File upload flow
   - Tool execution and broadcasting flow
   - Persistence points diagram
   - Message state transitions
   - Storage location reference
   - WebSocket message types

## Quick Navigation

**I want to understand:**
- How the chat system works → Start with `CHAT_ARCHITECTURE.md` Section 1-2
- Where conversations are stored → Go to `QUICK_REFERENCE.md` → "Where is conversation history stored?"
- How messages flow → See `DATA_FLOW.md` Section 1
- The frontend state management → `CHAT_ARCHITECTURE.md` Section 9
- The backend server logic → `CHAT_ARCHITECTURE.md` Section 9
- How to implement a new feature → `QUICK_REFERENCE.md` → "File Organization Guide"

## Key Facts to Remember

### Storage
- **Frontend**: localStorage (1000 messages max)
- **Backend In-Memory**: MessagePersistence singleton (lost on restart)
- **Backend File System**: `/data/A1/[convId]/` (todos.json, info.json, files/)
- **Missing**: Persistent conversation history to disk

### IDs
- **Conversation ID**: Generated on frontend, format: `conv_[timestamp]_[random]`
- **Project ID**: Hardcoded as `"A1"`
- **Session ID**: Generated on backend connection
- **Message ID**: Generated by frontend and backend separately

### Real-time
- **WebSocket Server Port**: 5040 (default)
- **Connection**: `ws://localhost:5040/api/ws?convId=[convId]`
- **Streaming**: LLM responses streamed as chunks
- **Broadcasting**: Messages broadcast to all clients in same conversation

### Tools
- **Tools**: File, Todo, Memory, Script, etc.
- **Execution**: On backend, results broadcast to frontend
- **Persistence**: Tool results saved to conversation history

## File Paths at a Glance

```
Frontend Core
  useChatStore        → frontend/src/stores/chat-store.ts
  useChat hook        → frontend/src/hooks/use-chat.ts
  WSClient            → frontend/src/lib/ws/ws-client.ts
  ConvId manager      → frontend/src/lib/conv-id.ts
  Message types       → frontend/src/components/ui/chat/messages/types.ts

Backend Core
  WSServer            → backend/src/ws/entry.ts
  Conversation        → backend/src/llm/conversation.ts
  Message persistence → backend/src/ws/msg-persistance.ts
  File storage        → backend/src/storage/file-storage.ts
  HTTP/WS server      → backend/src/server/index.ts

Data
  Conversations       → backend/data/A1/[convId]/
  Project memory      → backend/data/A1/memory.json
```

## Next Steps for Development

If you're looking to:

1. **Add persistent conversation history**
   - See `QUICK_REFERENCE.md` → "To persist conversation history to disk"
   - Implement `history.json` in `/data/A1/[convId]/`

2. **Support multiple projects**
   - See `QUICK_REFERENCE.md` → "To make Project ID dynamic"
   - Update hardcoded `"A1"` throughout the codebase

3. **Add user authentication**
   - See `QUICK_REFERENCE.md` → "To implement user authentication"
   - Consider `/data/[projectId]/[userId]/[convId]/` structure

4. **Scale to multiple servers**
   - Need to replace in-memory MessagePersistence with database
   - Consider Redis for distributed session storage
   - Implement database for persistent messages

5. **Understand a specific feature**
   - Use `DATA_FLOW.md` to see the flow
   - Use `QUICK_REFERENCE.md` to find the file
   - Use `CHAT_ARCHITECTURE.md` for detailed explanation

## Document Maintenance

These documents should be updated when:
- New message types are added
- Storage mechanism changes
- New files are created in key directories
- Important behaviors change

Current as of: December 1, 2025

